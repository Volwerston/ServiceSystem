@model ServiceSystem.Models.UserInfoViewModel

@{
    ViewBag.Title = "InternalAccountPage";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div style="border: 1px solid grey; border-radius: 5px; background-color: lightgray; max-width: 80%; padding: 20px; margin: auto; margin-top: 15px; margin-bottom: 15px;">
    <div class="row" style="padding: 10px;">
        <div class="col-sm-10 col-md-6 col-md-offset-3 col-sm-offset-1" style="border: 1px solid grey;background-color: azure; border-radius: 5px;">
            <div>
                <dl class="dl-horizontal">
                    <dt>
                        ПІБ:
                    </dt>

                    <dd>
                        <p>@Model.LastName @Model.FirstName @Model.FatherName</p>
                    </dd>

                    <dt>
                        Організація:
                    </dt>

                    <dd>
                        <p>@Html.DisplayFor(model => model.Organisation)</p>
                    </dd>

                    <dt>
                        E-mail:
                    </dt>

                    <dd>
                        <p>@Model.Email</p>
                    </dd>

                </dl>
            </div>
        </div>
    </div>
    <div class="row" style="padding: 10px;">
        <div class="col-xs-12">
            <div class="panel-group" id="accordion">
                <div class="panel panel-default">
                    <div class="panel-heading"  id="panel_1">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion" href="#collapse1">
                                Послуги
                            </a>
                        </h4>
                    </div>
                    <div id="collapse1" class="panel-collapse collapse">
                        <div class="panel-body" id="panel_body_1">
                        </div>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading" id="panel_2">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion" href="#collapse2">
                                Заявки на мої послуги
                            </a>
                        </h4>
                    </div>
                    <div id="collapse2" class="panel-collapse collapse">
                        <div class="panel-body" id="panel_body_2">
                        </div>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading" id="panel_3">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion" href="#collapse3">
                                Залишені мною заявки
                            </a>
                        </h4>
                    </div>
                    <div id="collapse3" class="panel-collapse collapse">
                        <div class="panel-body" id="panel_body_3">
                        </div>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading" id="panel_4">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion" href="#collapse4">
                                Діалоги
                            </a>
                        </h4>
                    </div>
                    <div id="collapse4" class="panel-collapse collapse">
                        <div class="panel-body" id="panel_body_4">
                        </div>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading" id="panel_5">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion" href="#collapse5">
                                Повідомлення
                            </a>
                        </h4>
                    </div>
                    <div id="collapse5" class="panel-collapse collapse">
                        <div class="panel-body" id="panel_body_5">
                        </div>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading" id="panel_6">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion" href="#collapse6">
                                Налаштування
                            </a>
                        </h4>
                    </div>
                    <div id="collapse6" class="panel-collapse collapse">
                        <div class="panel-body" id="panel_body_6">
                            <div class="row">
                                <div class="col-sm-8 col-sm-offset-2">
                                    <input type="checkbox" name="receive_email" />
                                    <label for="receive_email">отримувати сповіщення на електронну пошту</label>
                                </div>
                            </div>
                            <div class="row" style="margin-top: 10px;">
                                <div class="col-sm-4 col-sm-offset-4">
                                    <input type="button" name="confirm_user_changes" class="btn btn-success btn-block" value="Зберегти" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




@section scripts{
    
    <script type="text/javascript">

        function GetDivForService(service)
        {
            var str = '<tr style="cursor: pointer">'
                    + '<td onclick=\'location.href="@Url.Action("ServiceDetails", "Service")?id=' + service.Id + '"\'>'
                    + '<p>' + service.Id + '</p>'
                    + '</td>'
                    + '<td onclick=\'location.href="@Url.Action("ServiceDetails", "Service")?id=' + service.Id + '"\'>'
                    + '<p>' + service.Name + '</p>'
                    + '</td>'
                    + '<td onclick=\'location.href="@Url.Action("ServiceDetails", "Service")?id=' + service.Id + '"\'>'
                    + '<p>' + service.Type + '</p>'
                    + '</td>'
                    + '<td onclick=\'location.href="@Url.Action("ServiceDetails", "Service")?id=' + service.Id + '"\'>'
                    + '<p>' + service.Category + '</p>'
                    + '</td>'
                    + '<td>'
                    + '<button type="button" onclick=\'location.href="@Url.Action("ServiceCharts", "Service")?id=' + service.Id + '"\' class="btn btn-success btn-block btn-sm">Деталі'
                    + '</button>'
                    + '</td>'
                    + '</tr>';

            return str;
        }

        function GetDivForApplicationHeader(body_id) {
            return '<div class="table-responsive">'
            + '<table class="table table-striped table-bordered">'
            + '<thead>'
            + '<td>'
            + '<p><b>ID</b></p>'
            + '</td>'
            + '<td>'
            + '<p><b>Назва</b></p>'
            + '</td>'
            + '<td>'
            + '<p><b>Замовник</b></p>'
            + '</td>'
            + '<td>'
            + '<p><b>Статус</b></p>'
            + '</td>'
            + '<td>'
            + '<p><b>Остання зміна</b></p>'
            + '</td>'
            + '</thead>'
            + '<tbody id="' + body_id + '">'
            + '</tbody>'
            + '</table>'
            + '</div>';
        }

        function GetDivForDialogueHeader() {
            return '<div class="table-responsive">'
            + '<table class="table table-striped table-bordered">'
                    + '<thead>'
                    + '<td>'
                    + '<p><b>ID</b></p>'
                    + '</td>'
                    + '<td>'
                    + '<p><b>Повідомлень</b></p>'
                    + '</td>'
                    + '<td>'
                    + '<p><b>Учасників</b></p>'
                    + '</td>'
                    + '<td>'
                    + '<p><b>Остання зміна</b></p>'
                    + '</td>'
                    + '<td>'
                    + '<p><b>Останнє повідомлення</b></p>'
                    + '</td>'
                    + '</thead>'
                    + '<tbody id="dialogue_table_body">'
                    + '</tbody>'
                    + '</table>'
                    + '</div>';
        }

        function GetDivForDialogue(d) {
            return '<tr style="cursor: pointer;" onclick=\'location.href="@Url.Action("Dialogue", "Service")?id=' + d.Id + '"\'>'
                    + '<td>'
                    + '<p>' + d.Id + '</p>'
                    + '</td>'
                    + '<td>'
                    + '<p>' + d.MessagesNumber + '</p>'
                    + '</td>'
                    + '<td>'
                    + '<p>' + d.ParticipantsNumber + '</p>'
                    + '</td>'
                    + '<td>'
                    + '<p>' + d.LastChangeTime.split('T')[0] + ' ' + d.LastChangeTime.split('T')[1] + '</p>'
                    + '</td>'
                    + '<td>'
                    + '<p class="text-center">' + d.LastMessage + '</p>'
                    + '</td>'
                    + '</tr>';
        }


        function GetDivForApplication(app) {
            return  '<tr style="cursor: pointer" onclick=\'location.href="@Url.Action("ApplicationDetails", "Service")?id=' + app.Id + '"\'>'
                    + '<td>'
                    + '<p>' + app.Id + '</p>'
                    + '</td>'
                    + '<td>'
                    + '<p>' + app.ServiceName + '</p>'
                    + '</td>'
                    + '<td>'
                    + '<p>' + app.Username + '</p>'
                    + '</td>'
                    + '<td>'
                    + '<p>' + app.Status + '</p>'
                    + '</td>'
                    + '<td>'
                    + '<p>' + app.StatusChangeDate.split('T')[0] + ' ' + app.StatusChangeDate.split('T')[1] + '</p>'
                    + '</td>'
                    + '</tr>'
                    + '</a>';
        }


        function GetDivForNotification(note) {
            return '<div style="padding: 5px; margin: 10px;" id="notification_' + note.Id + '">'
                    + '<a class="close pull-right" id="note_' + note.Id + '">&times;</a>'
                    + '<div class="row" style="margin-top: 5px; border: 1px solid green; border-radius: 3px;">'
                    + '<div class="col-xs-6" style="word-break: break-all;">'
                    + '<p>From: ' + note.SenderName + '</p>'
                    + '</div>'
                    + '<div class="col-xs-6" style="word-break: break-all">'
                    + '<p>To: ' + note.RecipientName + '</p>'
                    + '</div>'
                    + '<div class="col-xs-12" style="word-break: break-all; margin-top: 5px;">'
                    + '<p>' + note.SendingTime.split('T')[0] + ' ' + note.SendingTime.split('T')[1] + '</p>'
                    + '</div>'
                    + '<div class="col-xs-12" style="word-break: break-all; margin-top: 5px;">'
                    + '<p>' + note.Text + '</p>'
                    + '</div>'
                    + '</div>'
                    + '</div>';
        }


        function GetDivForServiceHeader() {
            return '<div class="table-responsive">'
                    + '<table class="table table-striped table-bordered">'
                    + '<thead>'
                    + '<td>'
                    + '<p><b>ID</b></p>'
                    + '</td>'
                    + '<td>'
                    + '<p><b>Сервіс</b></p>'
                    + '</td>'
                    + '<td>'
                    + '<p><b>Тип</b></p>'
                    + '</td>'
                    + '<td>'
                    + '<p><b>Категорія</b></p>'
                    + '</td>'
                    + '<td>'
                    + '<p><b>Статистика</b></p>'
                    + '</td>'
                    + '</thead>'
                    + '<tbody id="service_table_body">'
                    + '</tbody>'
                    + '</table>'
                    + '</div>';
        }

        $(document).ready(function () {

            $('input[name="confirm_user_changes"]').click(function () {

                var toPass = {
                    Email: '@Model.Email',
                    ReceiveEmail: $('input[name="receive_email"]').is(":checked")
                }

                $.ajax({
                    method: "POST",
                    url: "/api/Account/PostUserSettings",
                    headers: {
                        Authorization: 'Bearer ' + localStorage.getItem("access_token"),
                    },
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: JSON.stringify(toPass),
                    success: function (res) {
                        displayMessage("Success", "Changes successfully submitted");
                    },
                    error: function (res) {
                        displayMessage("Error", res.responseText);
                    }
                });

            });

            $("#panel_1").click(function () {

                if(!($("#collapse1").hasClass("in")))
                {
                    if($("#panel_body_1").children().length == 0)
                    {
                        $.ajax({
                            method: "GET",
                            url: "/api/ServiceApi/UserCreatedServices",
                            async: false,
                            headers: {
                                Authorization: 'Bearer ' + localStorage.getItem("access_token"),
                            },
                            contentType: "application/json; charset=utf-8",
                            success: function(res)
                            {
                                if (res.length > 0) {
                                    $("#panel_body_1").append(GetDivForServiceHeader());
                                    for (var i = 0; i < res.length; ++i) {
                                        var str = GetDivForService(res[i]);
                                        $("#service_table_body").prepend(GetDivForService(res[i]));
                                    }
                                }
                                else {
                                    $("#panel_body_1").append('<p class="text-center">Сервісів не знайдено</p>');
                                }
                            },
                            error: function(res)
                            {
                                displayMessage("Error", res.responseText);
                            }
                        });
                    }
                }

            });


            $("#panel_4").click(function () {

                if (!($("#collapse4").hasClass("in"))) {
                    if ($("#panel_body_4").children().length == 0) {
                        $.ajax({
                            method: "GET",
                            url: "/api/Dialogue/UserDialogues",
                            async: false,
                            headers: {
                                Authorization: 'Bearer ' + localStorage.getItem("access_token"),
                            },
                            contentType: "application/json; charset=utf-8",
                            success: function (res) {
                                if (res != null) {
                                        $("#panel_body_4").append(GetDivForDialogueHeader());
                                        for (var i = 0; i < res.length; ++i) {
                                            var str = GetDivForDialogue(res[i]);
                                            $("#dialogue_table_body").prepend(GetDivForDialogue(res[i]));
                                    }
                                }
                                else {
                                    $("#panel_body_4").append('<p class="text-center">Діалогів не знайдено</p>');
                                }
                            },
                            error: function (res) {
                                displayMessage("Error", res.responseText);
                            }
                        });
                    }
                }
            });

            $("#panel_2").click(function () {
                if (!($("#collapse2").hasClass("in"))) {
                    if ($("#panel_body_2").children().length == 0) {
                        $.ajax({
                            method: "GET",
                            url: "/api/Application/GetServiceApplications?name=" + '@Model.Email',
                            async: false,
                            headers: {
                                Authorization: 'Bearer ' + localStorage.getItem("access_token"),
                            },
                            contentType: "application/json; charset=utf-8",
                            success: function (res) {

                                if (res.length > 0) {
                                    $("#panel_body_2").append(GetDivForApplicationHeader("to_my_app_table_body"));
                                    for (var i = 0; i < res.length; ++i) {
                                        var str = GetDivForApplication(res[i]);
                                        $("#to_my_app_table_body").prepend(GetDivForApplication(res[i]));
                                    }
                                }
                                else {
                                    $("#panel_body_2").append('<p class="text-center">Заявок не знайдено</p>');
                                }
                            },
                            error: function (res) {
                                displayMessage("Error", res.responseText);
                            }
                        });
                    }
                }

            });


            $("#panel_3").click(function () {
                if (!($("#collapse3").hasClass("in"))) {
                    if ($("#panel_body_3").children().length == 0) {
                        $.ajax({
                            method: "GET",
                            url: "/api/Application/GetUserApplications?name=" + '@Model.Email',
                            async: false,
                            headers: {
                                Authorization: 'Bearer ' + localStorage.getItem("access_token"),
                            },
                            contentType: "application/json; charset=utf-8",
                            success: function (res) {
                                if (res.length > 0) {
                                    $("#panel_body_3").append(GetDivForApplicationHeader("my_app_table_body"));
                                    for (var i = 0; i < res.length; ++i) {
                                        $("#my_app_table_body").prepend(GetDivForApplication(res[i]));
                                    }
                                }
                                else {
                                    $("#panel_body_3").append('<p class="text-center">Заявок не знайдено</p>');
                                }
                            },
                            error: function (res) {
                                displayMessage("Error", res.responseText);
                            }
                        });
                    }
                }

            });

            $("#panel_5").click(function () {

                if (!($("#collapse5").hasClass("in"))) {
                    if ($("#panel_body_5").children().length == 0) {
                        $.ajax({
                            method: "GET",
                            url: "/api/ServiceApi/UserNotifications",
                            async: false,
                            headers: {
                                Authorization: 'Bearer ' + localStorage.getItem("access_token"),
                            },
                            contentType: "application/json; charset=utf-8",
                            success: function (res) {
                                if (res != null) {
                                    for (var i = 0; i < res.length; ++i) {
                                        $("#panel_body_5").prepend(GetDivForNotification(res[i]));
                                    }

                                    $('a[id^="note"]').click(function () {

                                        var note_id = $(this).attr('id').split('_')[1];

                                        $.ajax({
                                            method: "POST",
                                            url: "/api/ServiceApi/DeleteNotification",
                                            contentType: "application/json; charset=utf-8",
                                            dataType: "json",
                                            data: JSON.stringify(note_id),
                                            headers: {
                                                Authorization: 'Bearer ' + localStorage.getItem('access_token')
                                            },
                                            success: function(res)
                                            {
                                                $("#notification_" + note_id).remove();

                                                if($("#panel_body_5").children().length == 0)
                                                {
                                                    $("#panel_body_5").append('<p class="text-center">Повідомлень не знайдено</p>')
                                                }
                                            },
                                            error: function (res) {
                                                displayMessage("Error", res.responseText);
                                            }
                                        });

                                    });
                                }
                                else {
                                    $("#panel_body_5").append('<p class="text-center">Повідомлень не знайдено</p>');
                                }
                            },
                            error: function (res) {
                                displayMessage("Error", res.responseText);
                            }
                        });
                    }
                }

            });

        });


    </script>
    
    }