
@{
    ViewBag.Title = "ServiceSearch";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row">
    <div class="col-xs-10 col-sm-10 col-md-10 col-lg-10 col-md-offset-1 col-lg-offset-1">
        <div class="row">
            <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                <div class="form-horizontal well" style="display: table;">
                    <div class="form-group">
                        @Html.DropDownList("category", (List<SelectListItem>)ViewData["CATEGORIES"], new { @class = "form-control", style = "margin:auto;", id = "category" })
                    </div>
                    <div class="form-group">
                        <input name="name" placeholder="Введіть критерій пошуку" class="form-control" style="margin: auto;" />
                    </div>
                    <div class="form-group">
                        <input name="description_search" id="description_search" checked type="checkbox" class="col-xs-1 col-sm-1 col-md-1 col-lg-1" />
                        <label for="description_search" class="col-xs-8 col-sm-8 col-md-8 col-lg-8">шукати в описі</label>
                    </div>
                    <div class="form-group">
                        <select name="service_type" class="form-control col-xs-8 col-sm-8 col-md-8 col-lg-8" id="baseController">
                            <option value="None">Оберіть тип</option>
                            <option value="Session">Сеанс</option>
                            <option value="Course">Курс</option>
                            <option value="Deadline">Дедлайн</option>
                        </select>
                    </div>
                    <input class="btn btn-success btn-block" id="searchButton" style="margin: auto;" value="Шукати" />
                </div>
            </div>
            <div class="col-xs-8 col-sm-8 col-lg-8 col-md-8" id="servicesData">
            </div>
        </div>
    </div>
</div>

@section scripts{

    <script type="text/javascript">

        var lastId = 0;

        var tempName = null;
        var tempCategory = null;
        var tempType = null;
        var tempDescriptionSearch = null;


        function getDivForService(service)
        {
            return '<a href="@Url.Action("ServiceDetails", "Service")?id=' + service.Id + '"\"">'
            + '<div class="row text-center" style="margin-bottom: 10px;">'
         + '<div style="border: 2px solid green; border-radius: 7px; min-height: 300px;" class="col-xs-10 col-sm-10 col-md-10 col-lg-10 col-md-offset-1 col-lg-offset-1">'
            + '<h3>' + service.Name + '</h3>'
            + '<p>' + service.Description + '</p>'
        + '</div>'
            + '</div>'
            + '</a>';
        }

        $(document).ready(function () {

            $(document).scroll(function () {
                if ($(document).height() - ($(window).height() + $(window).scrollTop()) < 50) {

                    var toPass = {
                        Name: tempName,
                        Category: tempCategory,
                        Type: tempType,
                        DescriptionSearch: tempDescriptionSearch,
                        LastID: lastId
                    };

                    $.ajax({
                        type: "POST",
                        url: "http://localhost:49332/api/ServiceApi/PostServiceParams",
                        dataType: "json",
                        data: JSON.stringify(toPass),
                        contentType: "application/json; charset=utf-8",
                        async: false,
                        success: function (res) {

                            var toProceed = JSON.parse(res);

                            if (toProceed != null) {

                                for (var i = 0; i < toProceed.length; ++i) {
                                    $("#servicesData").append(getDivForService(toProceed[i]));
                                }

                                lastId = toProceed[toProceed.length - 1].Id;
                            }
                            else {

                                if ($("#servicesData").children().length == 0) {
                                    $("#servicesData").append('<div class="text-center">Інформації не знайдено</div>');
                                }
                            }
                        },
                        error: function (xhr, error, message) {

                            alert(message);
                        }
                    });
                }
            });

            $("#searchButton").click(function () {

                $("#servicesData").empty();
                lastId = 0;

                tempName = $('input[name="name"]').val();
                tempCategory = $('#category').val();
                tempType = $('select[name="service_type"]').val();
                tempDescriptionSearch = $('input[name="description_search"]').is(":checked");

                var toPass = {
                    Name: tempName,
                    Category: tempCategory,
                    Type: tempType,
                    DescriptionSearch: tempDescriptionSearch,
                    LastID: lastId
                };

                $.ajax({
                    type: "POST",
                    url: "http://localhost:49332/api/ServiceApi/PostServiceParams",
                    dataType: "json",
                    data: JSON.stringify(toPass),
                    contentType: "application/json; charset=utf-8",
                    success: function(res)
                    {

                        var toProceed = JSON.parse(res);

                        if(toProceed != null)
                        {

                            for (var i = 0; i < toProceed.length; ++i) {
                                $("#servicesData").append(getDivForService(toProceed[i]));
                            }

                            lastId = toProceed[toProceed.length - 1].Id;
                        }
                        else {
                            if ($("#servicesData").children().length == 0) {
                                $("#servicesData").append('<div class="text-center">Інформації не знайдено</div>');
                            }
                        }
                    },
                    error: function(res)
                    {
                        alert(res.status + " " + res.statusText);
                    }
                });

            });

        });
    </script>

    }